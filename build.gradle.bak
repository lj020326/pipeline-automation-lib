// Apply Groovy/Java plugins
plugins {
    id 'groovy' // Required for Groovy compilation
    id 'java'
}

// Fixed: Using explicit '=' assignment to address Gradle deprecation warning
group = 'com.dettonville.pipeline'
version = '1.0.0-SNAPSHOT'

// --- Java Compatibility Configuration ---
// We target Java 8 for Jenkins compatibility.
java {
    // Set explicit source and target compatibility to Java 1.8 (Java 8)
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8

    toolchain {
        languageVersion = JavaLanguageVersion.of(8)
    }
}
// ---------------------------------------------------------

// --- Explicit Source Set Configuration to find tests ---
// Configuration to find unit tests (now in src/test/groovy) and integration tests (in src/test/vars).
sourceSets {
    main {
        // Look for main groovy code in 'src' and 'src/main'
        groovy.srcDirs = ['src', 'src/main']
    }
    test {
        groovy.srcDirs = ['src/test/groovy', 'src/test/vars']
        compileClasspath += main.output
        runtimeClasspath += main.output
    }
}
// ---------------------------------------------------------


repositories {
    // FIX: Removing the transient 'incrementals' and 'snapshots' repos and relying
    // on stable versions found in 'public' and 'releases'.
    maven { url "https://repo.jenkins-ci.org/public/" }
    maven { url "https://repo.jenkins-ci.org/releases/" }
    mavenCentral()
}

dependencies {
    // --- Jenkins Shared Library Dependencies (compileOnly) ---

    // 1. Core Jenkins APIs (FIX: Downgrading to the last Java 8 LTS baseline)
    compileOnly 'org.jenkins-ci.main:jenkins-core:2.303.3'

    // FIX: Explicitly adding the Servlet API dependency needed by jenkins-core
    // for classes like hudson.model.Job that rely on javax.servlet classes.
    compileOnly 'javax.servlet:servlet-api:2.5'

    // 2. Workflow/Pipeline Classes (Downgrading to align with the older 2.303.3 core)
    compileOnly 'org.jenkins-ci.plugins.workflow:workflow-cps:2.85'

    // NEW FIX: workflow-support contains core pipeline annotations like @NonCPS,
    // which must be available during main Groovy compilation.
    compileOnly 'org.jenkins-ci.plugins.workflow:workflow-support:3.8'

    // 3. Credentials Plugin (Keep version 2.1.0, assumed Java 8 compatible)
    compileOnly 'org.jenkins-ci.plugins:credentials:2.1.0'

    // 4. Pipeline Utility Steps (Keep standard version, it should resolve)
    compileOnly 'org.jenkins-ci.plugins:pipeline-utility-steps:2.16.0'

    // 5. Script Security (FIX: Downgrading to a stable, pre-Java 11 compatible version)
    compileOnly 'org.jenkins-ci.plugins:script-security:1.76'

    // 6. Version Number Plugin (Using the corrected artifact ID 'versionnumber', version 1.7)
    compileOnly 'org.jvnet.hudson.tools:versionnumber:1.7'

    // --- Testing Dependencies (testImplementation) ---
    // ACTION: Updated test dependencies to match the new stable versions used above.

    // 1. Groovy for testing
    testImplementation 'org.apache.groovy:groovy:4.0.20'

    // 2. Spock Framework
    testImplementation 'org.spockframework:spock-core:2.3-groovy-4.0'

    // 3. JUnit 4 (needed for older tests, resolves org.junit.Test/Assert)
    testImplementation 'junit:junit:4.13.2'

    // NEW FIX: Explicitly adding JUnit 5 API to satisfy the 'useJUnitPlatform()' configuration
    testImplementation 'org.junit.jupiter:junit-jupiter-api:5.10.2'

    // NEW FIX: Adding Hamcrest explicitly for 'org.hamcrest.CoreMatchers' imports
    testImplementation 'org.hamcrest:hamcrest-all:1.3'

    // 4. Mockito
    testImplementation 'org.mockito:mockito-core:5.11.0'

    // 5. Jenkins Pipeline Unit
    testImplementation 'com.github.meifans:jenkins-pipeline-unit-extension:1.15.0'

    // 6. Vintage Engine to run JUnit 4 tests
    testImplementation 'org.junit.vintage:junit-vintage-engine:5.10.2'

    // 7. Re-adding key Jenkins APIs to testImplementation scope (MUST MATCH compileOnly)
    testImplementation 'org.jenkins-ci.main:jenkins-core:2.303.3'
    testImplementation 'org.jenkins-ci.plugins.workflow:workflow-cps:2.85' // Match compileOnly
    testImplementation 'org.jenkins-ci.plugins:credentials:2.1.0' // Match compileOnly (FIXED GROUP)
}

// Groovy compilation task configuration
tasks.withType(GroovyCompile) {
    options.compilerArgs.add('-parameters')
}

// Configuration for the 'test' task (run via 'gradle test')
test {
    useJUnitPlatform() // Use JUnit Platform for Spock/JUnit 5 compatibility
    testLogging {
        events = ["passed", "skipped", "failed"]
    }
}
